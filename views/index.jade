doctype html
html(lang='en')
  head
    title PRV
    meta(charset='utf8')
    meta(name='robots', content='noindex, nofollow')
    link(rel='stylesheet', href='/stylesheets/style.css')

    script(src='/javascripts/jquery-1.11.1.min.js')
    script.
      // A simple document.reload() fails when the connection cuts out.
      // Instead, reload the body of the page through XHR and keep trying if
      // there's a failure.
      (function() {
        var settings = {
          cache: false,
          dataType: 'html',
          timeout: 5000,
          url: document.location.href,
          error: function(xhr, status, err) {
            console.error("Reloading failed: status=" + status + " error=" + err);
          },
          success: function(data, status, xhr) {
            var body = $($.parseHTML(data)).not('title, meta, link, script');
            $(document.body).empty().append(body);
            $('#refresh').text("Refreshed at: " + new Date());
          }
        };
        setInterval(function(){ $.ajax(settings); }, 60 * 1000);
      })();

  body

    div.navbar.navbar-inverse.navbar-fixed-top
      div.navbar-inner
        div.container
          a.brand(href='/') Pull Request Viewer
          div.pull-right.profile
            img(src=profile._json.avatar_url)
            = profile.displayName

    div.container

      table.table.table-bordered

        thead
          tr
            th Number
            th Title
            th Submitter
            th Reviewers
            th Review Status
            th Updated At
            th Last Comment
            th Build Status

        tbody
          for pull in pulls
            tr(class="pullrequest "+pull.class)
              td
                a(href=pull.html_url) ##{ pull.number }
              td
                = pull.displayTitle
                | &nbsp;
                for tag in pull.tags
                  span.label.label-default= tag.toLowerCase()
              td
                - var u = pull.submitter
                img(src=u.avatar, title=u.username)
              td
                if pull.anyReviewer
                  span.label.label-info Anybody
                else
                  for reviewer in pull.reviewers
                    if reviewer.avatar
                      - var u = reviewer
                      img(src=u.avatar, title=u.username)
                    else
                      span= reviewer.username
              td
                span(class="label label-"+pull.reviewStatusClass)= pull.reviewStatus
              td.nowrap
                = pull.last_update_string
              td.last_update
                if pull.last_comment && pull.last_user
                  - var u = pull.last_user
                  img(src=u.avatar, title=u.username)
                  a(href=pull.last_comment.html_url) ##{ pull.num_comments }
                  div.content= pull.last_comment.body
                else
                  span.muted (none)
              td
                span(class="label label-"+pull.buildStatusClass)= pull.buildStatus

      div.muted
        | Showing open pull requests from:
        for repo in settings.github.repos
          a.muted(href="https://github.com/"+repo.user+"/"+repo.repo)
            | &nbsp;
            | #{ repo.user }/#{ repo.repo }
        br
        | Approximate GitHub API calls remaining: #{ rateLimitRemaining }
        br
        | Pull Requests older than one month are hidden.
        br
        span#refresh Loaded at #{ new Date() }
